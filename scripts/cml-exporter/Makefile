# Makefile for processing cml-exporter-installer.sh.in and replacing macros with file contents

SRC = cml-exporter-installer.sh.in
OUT = cml-exporter-installer.sh

# List of macros and corresponding files
SHELL := /bin/bash

FILES  = scripts/cml-exporter scripts/cml-exporter.py scripts/cml-exporter.service scripts/cml-exporter.sh

# Generate sed script to replace macros with file contents
SED_SCRIPT = $(OUT).sed

all: $(OUT)

$(SED_SCRIPT): $(SRC) $(FILES)
	@echo "# Autogenerated sed script" > $@
	@for file in $(FILES); do \
		macro=$$(basename $${file} | sed -e 's/-/_/g' -e 's/\./_/g'); \
		echo "/@$$macro@/ {" >> $@; \
		echo "  r $$file" >> $@; \
		echo "  d" >> $@; \
		echo "}" >> $@; \
	done

$(OUT): $(SRC) $(FILES) $(SED_SCRIPT)
	sed -f $(SED_SCRIPT) $(SRC) > $(OUT)
	chmod +x $(OUT)

.PHONY: all clean
clean:
	rm -f $(OUT) $(SED_SCRIPT)